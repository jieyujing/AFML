# CLI Step Execution Specification

## ADDED Requirements

### Requirement: Modular Pipeline Step Execution

The pipeline MUST support executing individual steps via CLI `--step` parameter.

#### Scenario: Run specific pipeline step

- **GIVEN** the user runs `python afml_polars_pipeline.py --step <STEP_NAME> [options]`
- **WHEN** `<STEP_NAME>` is one of: `load`, `bars`, `labels`, `features`, `weights`, `cv`, `meta`, `bet`, `verify`, `all`
- **THEN** only that step is executed with its specific parameters
- **AND** visualization output is generated for verification

#### Scenario: Run all steps (default behavior)

- **GIVEN** the user runs `python afml_polars_pipeline.py` without `--step`
- **WHEN** no step is specified
- **THEN** the complete pipeline runs (equivalent to `--step all`)

#### Scenario: Load from previous step output

- **GIVEN** the user runs a step that depends on previous output (e.g., `--step labels`)
- **WHEN** `--input` points to a file generated by the previous step
- **THEN** the step loads that data and proceeds

#### Scenario: Memory-efficient streaming for large datasets

- **GIVEN** processing a large parquet directory (>100M rows)
- **WHEN** `--streaming` flag is provided
- **THEN** use Polars streaming mode to avoid loading entire dataset into memory

---

## ADDED Requirements

### Requirement: Step-specific Visualization

Each step MUST generate verification visualization when enabled.

#### Scenario: Generate visualization for dollar bars step

- **GIVEN** running `--step bars` with `--visualize`
- **WHEN** the step completes successfully
- **THEN** generates `step2_dollar_bars.png` with bar statistics

#### Scenario: Generate visualization for labels step

- **GIVEN** running `--step labels` with `--visualize`
- **WHEN** the step completes successfully
- **THEN** generates `step3_triple_barrier_sample.png` and `step3_label_distribution.png`

#### Scenario: Generate visualization for features step

- **GIVEN** running `--step features` with `--visualize`
- **WHEN** the step completes successfully
- **THEN** generates `step4_stationarity_search.png` and `step4_feature_correlations.png`

---

## ADDED Requirements

### Requirement: Individual Step Parameters

Each step MUST accept its specific parameters while sharing common options.

#### Scenario: Dollar bars step parameters

- **GIVEN** running `--step bars --daily-target 20`
- **WHEN** processing dollar bars
- **THEN** uses `daily_target=20` for threshold calculation

#### Scenario: Labels step parameters

- **GIVEN** running `--step labels --pt-sl 2.0 1.0 --vertical-barrier 24`
- **WHEN** applying triple barrier labels
- **THEN** uses PT=2.0, SL=1.0, vertical barrier=24 bars

#### Scenario: Features step parameters

- **GIVEN** running `--step features --windows 5 10 20 --ffd-d 0.6`
- **WHEN** generating features
- **THEN** uses windows [5,10,20] and ffd_d=0.6
